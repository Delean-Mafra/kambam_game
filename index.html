<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban EV - Demo Offline</title>
    <style>
/**
 * ===================================================================================
 * KANBAN EV - ESTILOS CSS (INLINE DEMO)
 * ===================================================================================
 */
:root {
    --color-primary: #3498db;
    --color-primary-dark: #2980b9;
    --color-secondary: #6c757d;
    --color-success: #28a745;
    --color-danger: #dc3545;
    --color-warning: #ffc107;
    --color-info: #17a2b8;
    --bg-main: #1a1a2e;
    --bg-secondary: #16213e;
    --bg-card: #0f3460;
    --bg-column: #1f4068;
    --text-primary: #ffffff;
    --text-secondary: #b8b8b8;
    --text-muted: #6c757d;
    --color-analyst: #e74c3c;
    --color-developer: #2ecc71;
    --color-tester: #3498db;
    --priority-low: #27ae60;
    --priority-medium: #f39c12;
    --priority-high: #e74c3c;
    --priority-urgent: #9b59b6;
    --category-feature: #3498db;
    --category-bug: #e74c3c;
    --category-improvement: #2ecc71;
    --category-tech-debt: #f39c12;
    --header-height: 70px;
    --footer-height: 50px;
    --sidebar-width: 320px;
    --column-min-width: 220px;
    --card-width: 200px;
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;
    --border-radius-sm: 4px;
    --border-radius-md: 8px;
    --border-radius-lg: 12px;
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
    --transition-fast: 0.15s ease;
    --transition-normal: 0.3s ease;
    --transition-slow: 0.5s ease;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 16px; scroll-behavior: smooth; }
body {
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--bg-main);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.5;
    overflow-x: hidden;
}

.header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: var(--header-height);
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--spacing-lg);
    box-shadow: var(--shadow-md);
    z-index: 100;
}
.header-left { display: flex; align-items: center; gap: var(--spacing-md); }
.header-left h1 { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); }
.header-left .subtitle { font-size: 0.875rem; color: var(--text-secondary); }
.header-center { display: flex; align-items: center; gap: var(--spacing-lg); }
.day-info { display: flex; flex-direction: column; align-items: center; background: var(--bg-card); padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--border-radius-md); }
.day-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
.day-value { font-size: 1.75rem; font-weight: 700; color: var(--color-primary); }
.header-right { display: flex; gap: var(--spacing-sm); }

.btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-xs); padding: var(--spacing-sm) var(--spacing-md); border: none; border-radius: var(--border-radius-md); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); text-decoration: none; }
.btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.btn:active { transform: translateY(0); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.btn-primary { background: var(--color-primary); color: white; }
.btn-primary:hover { background: var(--color-primary-dark); }
.btn-secondary { background: var(--color-secondary); color: white; }
.btn-success { background: var(--color-success); color: white; }
.btn-danger { background: var(--color-danger); color: white; }
.btn-large { padding: var(--spacing-md) var(--spacing-xl); font-size: 1rem; }
.btn-block { width: 100%; }

.main-container { display: grid; grid-template-columns: 1fr var(--sidebar-width); gap: var(--spacing-md); padding: calc(var(--header-height) + var(--spacing-md)) var(--spacing-md) var(--spacing-md); min-height: calc(100vh - var(--header-height)); }
.kanban-board { display: flex; gap: var(--spacing-md); overflow-x: auto; padding-bottom: var(--spacing-md); }
.kanban-column { flex: 0 0 var(--column-min-width); min-width: var(--column-min-width); background: var(--bg-column); border-radius: var(--border-radius-lg); padding: var(--spacing-md); display: flex; flex-direction: column; gap: var(--spacing-sm); }
.kanban-column.completed { background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%); }
.column-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: var(--spacing-sm); border-bottom: 2px solid rgba(255, 255, 255, 0.1); }
.column-header h2 { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
.card-count { background: var(--bg-card); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius-sm); font-size: 0.8rem; font-weight: 700; }
.wip-indicator { display: flex; align-items: center; gap: var(--spacing-xs); }
.wip-limit { color: var(--text-muted); font-size: 0.8rem; }
.wip-bar { height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden; position: relative; }
.wip-bar::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: var(--wip-percentage, 0%); background: var(--color-success); transition: all var(--transition-normal); }
.wip-bar.warning::after { background: var(--color-warning); }
.wip-bar.danger::after { background: var(--color-danger); }
.agent-slot { display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm); background: rgba(0, 0, 0, 0.2); border-radius: var(--border-radius-sm); font-size: 0.75rem; }
.agent-slot.analyst { border-left: 3px solid var(--color-analyst); }
.agent-slot.developer { border-left: 3px solid var(--color-developer); }
.agent-slot.tester { border-left: 3px solid var(--color-tester); }
.agent-icon { font-size: 1rem; }
.agent-name { flex: 1; color: var(--text-secondary); }
.agent-dice { background: var(--bg-card); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius-sm); font-weight: 700; color: var(--color-warning); }
.agent-slot.absent { opacity: 0.5; background: rgba(220, 53, 69, 0.2); }
.agent-slot.absent .agent-icon { filter: grayscale(100%); }
.agent-dice.agent-absent { background: var(--color-danger); color: white; animation: blink 1.5s infinite; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

.cards-container { flex: 1; min-height: 200px; display: flex; flex-direction: column; gap: var(--spacing-sm); padding: var(--spacing-xs); border-radius: var(--border-radius-sm); transition: background var(--transition-fast); }
.cards-container.drag-over { background: rgba(52, 152, 219, 0.2); outline: 2px dashed var(--color-primary); }
.cards-container.blocked { background: rgba(220, 53, 69, 0.1); }

.card { background: var(--bg-card); border-radius: var(--border-radius-md); padding: var(--spacing-md); cursor: grab; transition: all var(--transition-fast); border-left: 4px solid transparent; position: relative; }
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.card.dragging { opacity: 0.5; cursor: grabbing; }
.card.completed { animation: cardComplete 0.5s ease; }
@keyframes cardComplete { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 20px var(--color-success); } }
.card.priority-low { border-left-color: var(--priority-low); }
.card.priority-medium { border-left-color: var(--priority-medium); }
.card.priority-high { border-left-color: var(--priority-high); }
.card.priority-urgent { border-left-color: var(--priority-urgent); animation: urgentPulse 2s infinite; }
@keyframes urgentPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(155, 89, 182, 0); } }
.card-category { position: absolute; top: var(--spacing-sm); right: var(--spacing-sm); font-size: 0.65rem; padding: 2px 6px; border-radius: var(--border-radius-sm); text-transform: uppercase; font-weight: 600; }
.card-category.feature { background: var(--category-feature); }
.card-category.bug { background: var(--category-bug); }
.card-category.improvement { background: var(--category-improvement); }
.card-category.tech-debt { background: var(--category-tech-debt); }
.card-header { margin-bottom: var(--spacing-sm); }
.card-id { font-size: 0.7rem; color: var(--text-muted); margin-bottom: var(--spacing-xs); }
.card-title { font-size: 0.85rem; font-weight: 600; color: var(--text-primary); line-height: 1.3; }
.card-body { display: flex; flex-direction: column; gap: var(--spacing-xs); }
.card-progress { background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden; }
.card-progress-bar { height: 100%; background: var(--color-success); transition: width var(--transition-normal); }
.card-stats { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-secondary); }
.card-effort { display: flex; align-items: center; gap: var(--spacing-xs); }
.card-value { color: var(--color-success); font-weight: 600; }
.card-days { color: var(--text-muted); font-size: 0.7rem; }
.card.stale { background: linear-gradient(135deg, var(--bg-card) 0%, #5c3d2e 100%); }
.card.stale::after { content: '‚ö†Ô∏è'; position: absolute; top: var(--spacing-sm); right: var(--spacing-sm); }
.card.has-bug { border-left: 4px solid var(--color-danger); }
.card.deployed { opacity: 0.9; background: linear-gradient(135deg, var(--bg-card) 0%, #2d5016 100%); }
.ready-badge { background: var(--color-success); color: white; padding: 4px 8px; border-radius: var(--border-radius-sm); font-size: 0.7rem; font-weight: bold; margin-bottom: var(--spacing-xs); text-align: center; }
.bug-indicator { background: var(--color-danger); color: white; padding: 4px 8px; border-radius: var(--border-radius-sm); font-size: 0.7rem; font-weight: bold; margin-bottom: var(--spacing-xs); text-align: center; }
.deadline-indicator { padding: 4px 8px; border-radius: var(--border-radius-sm); font-size: 0.7rem; font-weight: bold; margin-bottom: var(--spacing-xs); text-align: center; }
.deadline-low { background: #2c3e50; color: #ecf0f1; }
.deadline-medium { background: var(--color-warning); color: #1a1a1a; }
.deadline-high { background: #e67e22; color: white; }
.deadline-urgent { background: var(--color-danger); color: white; animation: pulse 1s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
.specialist-controls { display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px solid rgba(255, 255, 255, 0.1); }
.specialist-btn { width: 28px; height: 28px; border: none; border-radius: 50%; background: var(--color-primary); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all var(--transition-fast); }
.specialist-btn:hover { background: var(--color-primary-dark); transform: scale(1.1); }
specialist-btn:active { transform: scale(0.95); }
.specialist-count { font-size: 0.85rem; font-weight: bold; color: var(--text-primary); min-width: 60px; text-align: center; }
.card-value.penalty { color: var(--color-danger); text-decoration: line-through; }

.sidebar { display: flex; flex-direction: column; gap: var(--spacing-md); max-height: calc(100vh - var(--header-height) - var(--spacing-md) * 2); overflow-y: auto; }
.panel { background: var(--bg-secondary); border-radius: var(--border-radius-lg); padding: var(--spacing-md); }
.panel h3 { font-size: 1rem; font-weight: 600; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); }
.stat-item { background: var(--bg-card); padding: var(--spacing-sm); border-radius: var(--border-radius-sm); text-align: center; }
.stat-label { font-size: 0.7rem; color: var(--text-secondary); display: block; margin-bottom: var(--spacing-xs); }
.stat-value { font-size: 1.1rem; font-weight: 700; }
.stat-value.positive { color: var(--color-success); }
.stat-value.negative { color: var(--color-danger); }
.stat-value.warning { color: var(--color-warning); }
.team-members { display: flex; flex-direction: column; gap: var(--spacing-sm); }
.team-member { background: var(--bg-card); padding: var(--spacing-sm); border-radius: var(--border-radius-sm); border-left: 3px solid transparent; }
.team-member.analyst { border-left-color: var(--color-analyst); }
.team-member.developer { border-left-color: var(--color-developer); }
.team-member.tester { border-left-color: var(--color-tester); }
.member-header { display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs); }
.member-icon { font-size: 1.2rem; }
.member-name { font-weight: 600; }
.member-stats { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); }
.member-stats .stat { display: flex; gap: var(--spacing-xs); }
.member-stats .efficiency { color: var(--color-primary); }
.member-stats .last-dice { color: var(--color-warning); font-weight: 700; }
.history-panel { max-height: 250px; }
.history-list { max-height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: var(--spacing-xs); }
.history-empty { text-align: center; color: var(--text-muted); padding: var(--spacing-md); }
.history-item { background: var(--bg-card); padding: var(--spacing-sm); border-radius: var(--border-radius-sm); font-size: 0.75rem; }
.history-item .day { color: var(--color-primary); font-weight: 600; }
.history-item .action { color: var(--text-primary); }
.actions-buttons { display: flex; flex-direction: column; gap: var(--spacing-sm); }

.charts-section { padding: var(--spacing-md); background: var(--bg-secondary); margin-top: var(--spacing-md); }
.charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
.chart-container { background: var(--bg-card); padding: var(--spacing-md); border-radius: var(--border-radius-lg); }
.chart-container h3 { font-size: 0.9rem; margin-bottom: var(--spacing-md); color: var(--text-primary); }
.chart-container canvas { width: 100% !important; height: 200px !important; }

.footer { position: fixed; bottom: 0; left: 0; right: 0; height: var(--footer-height); background: var(--bg-secondary); display: flex; align-items: center; justify-content: space-between; padding: 0 var(--spacing-lg); box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.2); z-index: 100; }
.footer-left { display: flex; gap: var(--spacing-md); }
.legend-item { display: flex; align-items: center; gap: var(--spacing-xs); font-size: 0.75rem; color: var(--text-secondary); }
.legend-color { width: 12px; height: 12px; border-radius: 2px; }
.legend-color.analyst { background: var(--color-analyst); }
.legend-color.developer { background: var(--color-developer); }
.legend-color.tester { background: var(--color-tester); }
.footer-center { font-size: 0.75rem; color: var(--text-muted); }
.footer-right { font-size: 0.8rem; color: var(--color-primary); }

.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 200; align-items: center; justify-content: center; padding: var(--spacing-md); }
.modal.active { display: flex; }
.modal-content { background: var(--bg-secondary); border-radius: var(--border-radius-lg); max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalSlideIn 0.3s ease; }
.modal-large { max-width: 700px; }
@keyframes modalSlideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
.modal-header h2 { font-size: 1.2rem; }
.modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; transition: color var(--transition-fast); }
.modal-close:hover { color: var(--text-primary); }
.modal-body { padding: var(--spacing-md); }
.modal-footer { display: flex; justify-content: flex-end; gap: var(--spacing-sm); padding: var(--spacing-md); border-top: 1px solid rgba(255, 255, 255, 0.1); }
.form-group { margin-bottom: var(--spacing-md); }
.form-group label { display: block; margin-bottom: var(--spacing-xs); font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
.form-group input, .form-group textarea, .form-group select { width: 100%; padding: var(--spacing-sm); background: var(--bg-card); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--border-radius-sm); color: var(--text-primary); font-size: 0.875rem; transition: border-color var(--transition-fast); }
.form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--color-primary); }
.form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
.export-textarea { width: 100%; min-height: 150px; padding: var(--spacing-sm); background: var(--bg-card); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--border-radius-sm); color: var(--text-primary); font-family: monospace; font-size: 0.75rem; resize: vertical; }
.help-content section { margin-bottom: var(--spacing-lg); }
.help-content h3 { font-size: 1rem; margin-bottom: var(--spacing-sm); color: var(--color-primary); }
.help-content p { color: var(--text-secondary); margin-bottom: var(--spacing-sm); }
.help-content ul { list-style: none; padding-left: var(--spacing-md); }
.help-content li { color: var(--text-secondary); margin-bottom: var(--spacing-xs); position: relative; }
.help-content li::before { content: '‚Ä¢'; position: absolute; left: -15px; color: var(--color-primary); }
.toast-container { position: fixed; top: calc(var(--header-height) + var(--spacing-md)); right: var(--spacing-md); z-index: 300; display: flex; flex-direction: column; gap: var(--spacing-sm); }
.toast { background: var(--bg-card); padding: var(--spacing-md); border-radius: var(--border-radius-md); box-shadow: var(--shadow-lg); min-width: 280px; animation: toastSlideIn 0.3s ease; display: flex; align-items: center; gap: var(--spacing-sm); }
@keyframes toastSlideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
.toast.success { border-left: 4px solid var(--color-success); }
.toast.error { border-left: 4px solid var(--color-danger); }
.toast.warning { border-left: 4px solid var(--color-warning); }
.toast.info { border-left: 4px solid var(--color-info); }
.toast-icon { font-size: 1.2rem; }
.toast-message { flex: 1; font-size: 0.875rem; }

@media (max-width: 1200px) {
    .main-container { grid-template-columns: 1fr; }
    .sidebar { max-height: none; flex-direction: row; flex-wrap: wrap; }
    .panel { flex: 1 1 300px; }
    .charts-grid { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
    .header { flex-direction: column; height: auto; padding: var(--spacing-sm); gap: var(--spacing-sm); }
    .header-left { flex-direction: column; text-align: center; }
    .header-center { width: 100%; justify-content: center; }
    .header-right { width: 100%; justify-content: center; }
    .main-container { padding-top: 180px; }
    .kanban-board { flex-direction: column; }
    .kanban-column { flex: none; width: 100%; }
    .footer { flex-direction: column; height: auto; padding: var(--spacing-sm); gap: var(--spacing-xs); }
    .footer-left { flex-wrap: wrap; justify-content: center; }
}
:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
.visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
@media (prefers-contrast: high) {
    :root { --bg-main: #000000; --bg-secondary: #1a1a1a; --bg-card: #2a2a2a; --text-primary: #ffffff; --text-secondary: #e0e0e0; }
    .card { border: 1px solid #ffffff; }
}
@media (prefers-reduced-motion: reduce) {
    * { animation: none !important; transition: none !important; }
}
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-main); }
::-webkit-scrollbar-thumb { background: var(--color-secondary); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }

.report-footer { background: var(--bg-secondary); border-top: 1px solid rgba(255, 255, 255, 0.1); padding: var(--spacing-lg) var(--spacing-md); margin-top: var(--spacing-lg); text-align: center; color: var(--text-secondary); font-size: 0.875rem; }
.report-footer .container { max-width: 100%; }
.report-footer p { margin-bottom: var(--spacing-sm); }
.report-footer p strong { color: var(--text-primary); font-weight: 600; }
.report-footer .mt-4 { margin-top: var(--spacing-lg); }
.report-footer a { color: var(--color-primary); text-decoration: none; transition: color var(--transition-fast); }
.report-footer a:hover { color: var(--color-primary-dark); text-decoration: underline; }
    </style>
</head>
<body>
    <header class="header" role="banner">
        <div class="header-left">
            <h1>üè≠ Kanban EV</h1>
            <span class="subtitle">Simulador de Fluxo de Trabalho √Ågil</span>
        </div>
        <div class="header-center">
            <div class="day-info">
                <span class="day-label">Dia</span>
                <span class="day-value" id="currentDay">0</span>
            </div>
            <button id="btnNextDay" class="btn btn-primary btn-large" aria-label="Avan√ßar para o pr√≥ximo dia">üé≤ Pr√≥ximo Dia</button>
        </div>
        <div class="header-right">
            <button id="btnRestart" class="btn btn-danger" aria-label="Reiniciar jogo">üîÑ Reiniciar</button>
            <button id="btnHelp" class="btn btn-secondary" aria-label="Abrir ajuda">‚ùì Ajuda</button>
        </div>
    </header>

    <main class="main-container" role="main">
        <section class="kanban-board" aria-label="Quadro Kanban">
            <div class="kanban-column" data-column="backlog">
                <div class="column-header"><h2>üìã Backlog</h2><span class="card-count">0</span></div>
                <div class="cards-container" id="backlog" role="listbox" aria-label="Cart√µes no Backlog" tabindex="0"></div>
            </div>
            <div class="kanban-column" data-column="ready">
                <div class="column-header"><h2>üéØ Pronto</h2><div class="wip-indicator"><span class="card-count">0</span><span class="wip-limit">/ 3</span></div></div>
                <div class="wip-bar" data-wip-limit="3"></div>
                <div class="cards-container" id="ready" role="listbox" aria-label="Cart√µes prontos para iniciar" tabindex="0"></div>
            </div>
            <div class="kanban-column" data-column="analysis">
                <div class="column-header"><h2>üîç An√°lise</h2><div class="wip-indicator"><span class="card-count">0</span><span class="wip-limit">/ 3</span></div></div>
                <div class="wip-bar" data-wip-limit="3"></div>
                <div class="agent-slot analyst" data-agent-type="analyst"><span class="agent-icon">üë§</span><span class="agent-name">Analista</span><span class="agent-dice" id="analystDice">-</span></div>
                <div class="cards-container" id="analysis" role="listbox" aria-label="Cart√µes em an√°lise" tabindex="0"></div>
            </div>
            <div class="kanban-column" data-column="development">
                <div class="column-header"><h2>üíª Desenvolvimento</h2><div class="wip-indicator"><span class="card-count">0</span><span class="wip-limit">/ 4</span></div></div>
                <div class="wip-bar" data-wip-limit="4"></div>
                <div class="agent-slot developer" data-agent-type="developer"><span class="agent-icon">üë§</span><span class="agent-name">Desenvolvedor</span><span class="agent-dice" id="developerDice">-</span></div>
                <div class="cards-container" id="development" role="listbox" aria-label="Cart√µes em desenvolvimento" tabindex="0"></div>
            </div>
            <div class="kanban-column" data-column="testing">
                <div class="column-header"><h2>üß™ Teste</h2><div class="wip-indicator"><span class="card-count">0</span><span class="wip-limit">/ 3</span></div></div>
                <div class="wip-bar" data-wip-limit="3"></div>
                <div class="agent-slot tester" data-agent-type="tester"><span class="agent-icon">üë§</span><span class="agent-name">Testador</span><span class="agent-dice" id="testerDice">-</span></div>
                <div class="cards-container" id="testing" role="listbox" aria-label="Cart√µes em teste" tabindex="0"></div>
            </div>
            <div class="kanban-column completed" data-column="deployed">
                <div class="column-header"><h2>‚úÖ Conclu√≠do</h2><span class="card-count">0</span></div>
                <div class="cards-container" id="deployed" role="listbox" aria-label="Cart√µes conclu√≠dos" tabindex="0"></div>
            </div>
        </section>

        <aside class="sidebar" role="complementary" aria-label="Painel de controle">
            <div class="panel stats-panel">
                <h3>üìä Estat√≠sticas</h3>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-label">Valor Entregue</span><span class="stat-value positive" id="totalValue">R$ 0</span></div>
                    <div class="stat-item"><span class="stat-label">Custo Acumulado</span><span class="stat-value negative" id="totalCost">R$ 0</span></div>
                    <div class="stat-item"><span class="stat-label">Lucro</span><span class="stat-value" id="profit">R$ 0</span></div>
                    <div class="stat-item"><span class="stat-label">Lead Time M√©dio</span><span class="stat-value" id="avgLeadTime">0 dias</span></div>
                    <div class="stat-item"><span class="stat-label">Throughput</span><span class="stat-value" id="throughput">0 / dia</span></div>
                    <div class="stat-item"><span class="stat-label">Bloqueios</span><span class="stat-value warning" id="blockedCount">0</span></div>
                </div>
            </div>
            <div class="panel team-panel">
                <h3>üë• Equipe</h3>
                <div class="team-members">
                    <div class="team-member analyst" id="teamAnalyst"><div class="member-header"><span class="member-icon">üîç</span><span class="member-name">Analista</span></div><div class="member-stats"><div class="stat"><span>Efici√™ncia:</span><span class="efficiency">2x</span></div><div class="stat"><span>√öltimo dado:</span><span class="last-dice">-</span></div></div></div>
                    <div class="team-member developer" id="teamDeveloper"><div class="member-header"><span class="member-icon">üíª</span><span class="member-name">Desenvolvedor</span></div><div class="member-stats"><div class="stat"><span>Efici√™ncia:</span><span class="efficiency">2x</span></div><div class="stat"><span>√öltimo dado:</span><span class="last-dice">-</span></div></div></div>
                    <div class="team-member tester" id="teamTester"><div class="member-header"><span class="member-icon">üß™</span><span class="member-name">Testador</span></div><div class="member-stats"><div class="stat"><span>Efici√™ncia:</span><span class="efficiency">2x</span></div><div class="stat"><span>√öltimo dado:</span><span class="last-dice">-</span></div></div></div>
                </div>
            </div>
            <div class="panel history-panel"><h3>üìú Hist√≥rico</h3><div class="history-list" id="historyList" role="log" aria-live="polite"><p class="history-empty">Nenhuma a√ß√£o ainda...</p></div></div>
            <div class="panel actions-panel"><h3>‚ö° A√ß√µes</h3><div class="actions-buttons"><button id="btnAddCard" class="btn btn-success btn-block">‚ûï Adicionar Cart√£o</button><button id="btnExportState" class="btn btn-secondary btn-block">üì§ Exportar Estado</button><button id="btnImportState" class="btn btn-secondary btn-block">üì• Importar Estado</button></div></div>
        </aside>
    </main>

    <section class="charts-section" aria-label="Gr√°ficos e m√©tricas">
        <div class="charts-grid">
            <div class="chart-container"><h3>üìà Diagrama de Fluxo Cumulativo (CFD)</h3><canvas id="cfdChart" aria-label="Gr√°fico de fluxo cumulativo"></canvas></div>
            <div class="chart-container"><h3>‚è±Ô∏è Lead Time por Cart√£o</h3><canvas id="leadTimeChart" aria-label="Gr√°fico de lead time"></canvas></div>
            <div class="chart-container"><h3>üí∞ Desempenho Financeiro</h3><canvas id="financialChart" aria-label="Gr√°fico financeiro"></canvas></div>
            <div class="chart-container"><h3>üìä Throughput por Dia</h3><canvas id="throughputChart" aria-label="Gr√°fico de throughput"></canvas></div>
        </div>
    </section>

    <footer class="footer" role="contentinfo">
        <div class="footer-left">
            <span class="legend-item"><span class="legend-color analyst"></span> Analista</span>
            <span class="legend-item"><span class="legend-color developer"></span> Desenvolvedor</span>
            <span class="legend-item"><span class="legend-color tester"></span> Testador</span>
        </div>
        <div class="footer-center">                        <p class="mt-4"><small>Copyright 2026 ¬© Delean Mafra - Todos os direitos reservados | Licen√ßa: <a href="https://delean-mafra.github.io/Ahtools/CC_BY_NC_4.0" target="_blank">CC BY-NC 4.0</a></small></p>
</div>
        <div class="footer-right"><span id="gameStatus">Aguardando in√≠cio...</span></div>
    </footer>

    <div id="modalCard" class="modal" role="dialog" aria-labelledby="modalCardTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalCardTitle">Adicionar Cart√£o</h2><button class="modal-close" aria-label="Fechar modal">&times;</button></div>
            <form id="formCard" class="modal-body">
                <div class="form-group"><label for="cardTitle">T√≠tulo *</label><input type="text" id="cardTitle" name="title" required placeholder="Ex: Implementar login" maxlength="50"></div>
                <div class="form-group"><label for="cardDescription">Descri√ß√£o</label><textarea id="cardDescription" name="description" rows="3" placeholder="Descri√ß√£o opcional da tarefa"></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label for="cardEffort">Esfor√ßo *</label><input type="number" id="cardEffort" name="effort" required min="1" max="20" value="5"></div>
                    <div class="form-group"><label for="cardValue">Valor (R$) *</label><input type="number" id="cardValue" name="value" required min="10" max="1000" value="100"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="cardPriority">Prioridade</label><select id="cardPriority" name="priority"><option value="low">Baixa</option><option value="medium" selected>M√©dia</option><option value="high">Alta</option><option value="urgent">Urgente</option></select></div>
                    <div class="form-group"><label for="cardCategory">Categoria</label><select id="cardCategory" name="category"><option value="feature">Feature</option><option value="bug">Bug</option><option value="improvement">Melhoria</option><option value="tech-debt">D√≠vida T√©cnica</option></select></div>
                </div>
            </form>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" id="btnCancelCard">Cancelar</button><button type="submit" form="formCard" class="btn btn-primary">Salvar</button></div>
        </div>
    </div>

    <div id="modalHelp" class="modal" role="dialog" aria-labelledby="modalHelpTitle" aria-hidden="true">
        <div class="modal-content modal-large">
            <div class="modal-header"><h2 id="modalHelpTitle">‚ùì Como Jogar</h2><button class="modal-close" aria-label="Fechar modal">&times;</button></div>
            <div class="modal-body help-content">
                <section><h3>üéØ Objetivo</h3><p>Gerencie o fluxo de trabalho de uma equipe de desenvolvimento para entregar o m√°ximo de valor poss√≠vel, respeitando os limites de WIP e minimizando o lead time.</p></section>
                <section><h3>üé≤ Mec√¢nica do Jogo</h3><ul><li><strong>Pr√≥ximo Dia:</strong> A cada dia, dados s√£o rolados para cada membro da equipe (1-6). Este √© o trabalho que podem realizar.</li><li><strong>Especialistas:</strong> Cada membro dobra seu valor quando trabalha em sua √°rea de especializa√ß√£o.</li><li><strong>Custo Di√°rio:</strong> R$ 300 por dia de opera√ß√£o.</li></ul></section>
                <section><h3>üìã Colunas do Quadro</h3><ul><li><strong>Backlog:</strong> Tarefas aguardando para serem iniciadas.</li><li><strong>Pronto:</strong> Tarefas prontas para serem puxadas.</li><li><strong>An√°lise:</strong> Tarefas sendo analisadas pelo Analista.</li><li><strong>Desenvolvimento:</strong> Tarefas sendo desenvolvidas.</li><li><strong>Teste:</strong> Tarefas sendo testadas.</li><li><strong>Conclu√≠do:</strong> Tarefas entregues que geram valor.</li></ul></section>
                <section><h3>üö¶ Limites de WIP</h3><p>Cada coluna tem um limite m√°ximo de cart√µes. Quando atingido, novos cart√µes n√£o podem entrar at√© que espa√ßo seja liberado. Isso ajuda a identificar gargalos.</p></section>
                <section><h3>üñ±Ô∏è Controles</h3><ul><li><strong>Arrastar:</strong> Mova cart√µes entre colunas (respeitando WIP).</li><li><strong>Pr√≥ximo Dia:</strong> Processa o trabalho do dia atual.</li><li><strong>Adicionar Cart√£o:</strong> Crie novos cart√µes no Backlog.</li></ul></section>
                <section><h3>üìä M√©tricas</h3><ul><li><strong>Lead Time:</strong> Tempo desde "Pronto" at√© "Conclu√≠do".</li><li><strong>Throughput:</strong> Cart√µes entregues por dia.</li><li><strong>CFD:</strong> Visualiza√ß√£o do fluxo acumulado ao longo do tempo.</li></ul></section>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary modal-close-btn">Entendi!</button></div>
        </div>
    </div>

    <div id="modalExport" class="modal" role="dialog" aria-labelledby="modalExportTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalExportTitle">üì§ Exportar Estado</h2><button class="modal-close" aria-label="Fechar modal">&times;</button></div>
            <div class="modal-body"><p>Copie o JSON abaixo para salvar o estado atual do jogo:</p><textarea id="exportData" class="export-textarea" readonly></textarea></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary modal-close-btn">Fechar</button><button type="button" class="btn btn-primary" id="btnCopyExport">Copiar</button></div>
        </div>
    </div>

    <div id="modalImport" class="modal" role="dialog" aria-labelledby="modalImportTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalImportTitle">üì• Importar Estado</h2><button class="modal-close" aria-label="Fechar modal">&times;</button></div>
            <div class="modal-body"><p>Cole o JSON exportado anteriormente:</p><textarea id="importData" class="export-textarea" placeholder='{"day": 0, "cards": [...], ...}'></textarea></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary modal-close-btn">Cancelar</button><button type="button" class="btn btn-primary" id="btnConfirmImport">Importar</button></div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container" aria-live="polite"></div>

    <footer class="report-footer">
        <div class="container">
            <p><strong>üè≠ Kanban EV - Simulador Educacional de Fluxo de Trabalho √Ågil</strong></p>
            <p>Hack Club - Hackatime Projects.</p>
        </div>
    </footer>

    <script>
// ===================================================================================
// REGRAS E CONFIGURA√á√ïES
// ===================================================================================
const CONFIG = {
    DAILY_COST_PER_SPECIALIST: 100,
    MAX_DAYS: 30,
    STALE_THRESHOLD: 5,
    MAX_SPECIALISTS_PER_COLUMN: 3,
    DAILY_COST_BASE: 300,
    WIP_LIMITS: { backlog: Infinity, ready: 3, analysis: 3, development: 4, testing: 3, deployed: Infinity },
    AGENT_EFFICIENCY: {
        analyst: { name: 'Analista', icon: 'üîç', color: 'analyst', baseEfficiency: 1, specialtyColumn: 'analysis', specialtyMultiplier: 2 },
        developer: { name: 'Desenvolvedor', icon: 'üíª', color: 'developer', baseEfficiency: 1, specialtyColumn: 'development', specialtyMultiplier: 2 },
        tester: { name: 'Testador', icon: 'üß™', color: 'tester', baseEfficiency: 1, specialtyColumn: 'testing', specialtyMultiplier: 2 }
    },
    EVENTS: { BUG_CHANCE_PER_DAY: 0.15, ABSENCE_CHANCE_PER_DAY: 0.1, TESTER_BUG_DETECTION: 0.3, ABSENCE_DURATION_MIN: 1, ABSENCE_DURATION_MAX: 2 },
    DEADLINE_CALCULATION: { BASE_DAYS: 10, DAYS_PER_100_VALUE: -0.5, MIN_DEADLINE: 3 },
    PENALTIES: { LATE_PENALTY_PERCENT: 0.1, MAX_PENALTY_PERCENT: 0.5 },
    WORK_COLUMNS: ['analysis', 'development', 'testing'],
    COLUMN_ORDER: ['backlog', 'ready', 'analysis', 'development', 'testing', 'deployed'],
    PRIORITIES: {
        low: { label: 'Baixa', color: '#27ae60', order: 1 },
        medium: { label: 'M√©dia', color: '#f39c12', order: 2 },
        high: { label: 'Alta', color: '#e74c3c', order: 3 },
        urgent: { label: 'Urgente', color: '#9b59b6', order: 4 }
    },
    CATEGORIES: {
        feature: { label: 'Feature', color: '#3498db' },
        bug: { label: 'Bug', color: '#e74c3c' },
        improvement: { label: 'Melhoria', color: '#2ecc71' },
        'tech-debt': { label: 'D√≠vida T√©cnica', color: '#f39c12' }
    }
};

const SAMPLE_CARDS = [
    { id: 'C001', title: 'Painel de Instrumentos', effort: 3, value: 200, priority: 'medium', category: 'feature', description: 'Implementar painel de instrumentos do ve√≠culo' },
    { id: 'C002', title: 'Atualiza√ß√£o ECU', effort: 5, value: 500, priority: 'high', category: 'feature', description: 'Atualizar firmware da unidade de controle' },
    { id: 'C003', title: 'Corre√ß√£o Sensor ABS', effort: 2, value: 150, priority: 'urgent', category: 'bug', description: 'Corrigir leitura incorreta do sensor ABS' },
    { id: 'C004', title: 'Otimiza√ß√£o Bateria', effort: 6, value: 600, priority: 'high', category: 'improvement', description: 'Otimizar consumo de bateria do sistema' },
    { id: 'C005', title: 'Interface Multim√≠dia', effort: 4, value: 300, priority: 'medium', category: 'feature', description: 'Nova interface do sistema multim√≠dia' },
    { id: 'C006', title: 'Diagn√≥stico OBD', effort: 3, value: 250, priority: 'low', category: 'feature', description: 'Sistema de diagn√≥stico OBD-II' },
    { id: 'C007', title: 'Refatorar Telemetria', effort: 4, value: 180, priority: 'low', category: 'tech-debt', description: 'Refatorar c√≥digo de telemetria legado' },
    { id: 'C008', title: 'C√¢mera de R√©', effort: 2, value: 200, priority: 'medium', category: 'feature', description: 'Integra√ß√£o com c√¢mera de r√©' },
    { id: 'C009', title: 'Bug Bluetooth', effort: 1, value: 100, priority: 'high', category: 'bug', description: 'Conex√£o Bluetooth cai intermitentemente' },
    { id: 'C010', title: 'GPS Melhorado', effort: 5, value: 400, priority: 'medium', category: 'improvement', description: 'Melhorar precis√£o do GPS' },
    { id: 'C011', title: 'Controle Clim√°tico', effort: 4, value: 350, priority: 'medium', category: 'feature', description: 'Sistema de controle clim√°tico inteligente' },
    { id: 'C012', title: 'Alerta Colis√£o', effort: 7, value: 700, priority: 'high', category: 'feature', description: 'Sistema de alerta de colis√£o frontal' },
    { id: 'C013', title: 'Limpeza C√≥digo USB', effort: 2, value: 80, priority: 'low', category: 'tech-debt', description: 'Limpar c√≥digo do driver USB' },
    { id: 'C014', title: 'Veloc√≠metro Digital', effort: 3, value: 220, priority: 'medium', category: 'feature', description: 'Novo veloc√≠metro digital HD' },
    { id: 'C015', title: 'Falha Airbag', effort: 2, value: 300, priority: 'urgent', category: 'bug', description: 'Corrigir falso positivo do sensor de airbag' },
    { id: 'C016', title: 'Economia Energia', effort: 5, value: 450, priority: 'medium', category: 'improvement', description: 'Modo de economia de energia avan√ßado' },
    { id: 'C017', title: 'Assistente Voz', effort: 8, value: 800, priority: 'low', category: 'feature', description: 'Integra√ß√£o com assistente de voz' },
    { id: 'C018', title: 'Atualiza√ß√£o OTA', effort: 6, value: 550, priority: 'high', category: 'feature', description: 'Sistema de atualiza√ß√£o over-the-air' },
    { id: 'C019', title: 'Logs Diagn√≥stico', effort: 3, value: 150, priority: 'low', category: 'tech-debt', description: 'Melhorar sistema de logs de diagn√≥stico' },
    { id: 'C020', title: 'Parking Assist', effort: 5, value: 500, priority: 'medium', category: 'feature', description: 'Assistente de estacionamento autom√°tico' }
];

const Rules = {
    validateMove(fromColumn, toColumn, gameState) {
        if (fromColumn === toColumn) return { valid: false, reason: 'Cart√£o j√° est√° nesta coluna' };
        const fromIndex = CONFIG.COLUMN_ORDER.indexOf(fromColumn);
        const toIndex = CONFIG.COLUMN_ORDER.indexOf(toColumn);
        if (toIndex > fromIndex + 1) return { valid: false, reason: 'N√£o pode pular colunas' };
        const wipLimit = CONFIG.WIP_LIMITS[toColumn];
        const currentCount = gameState.cards.filter(c => c.currentColumn === toColumn).length;
        if (currentCount >= wipLimit) return { valid: false, reason: `Limite de WIP atingido (${wipLimit})` };
        if (toIndex > fromIndex && CONFIG.WORK_COLUMNS.includes(fromColumn)) {
            const card = gameState.cards.find(c => c.currentColumn === fromColumn && c.id === gameState._movingCardId);
            if (card && card.effortDone < card.effortRequired) return { valid: false, reason: 'Trabalho n√£o conclu√≠do nesta etapa' };
        }
        return { valid: true, reason: '' };
    },
    canPullFromBacklog(gameState) {
        const readyCount = gameState.cards.filter(c => c.currentColumn === 'ready').length;
        const wipLimit = CONFIG.WIP_LIMITS.ready;
        if (readyCount >= wipLimit) return { valid: false, reason: `Coluna "Pronto" cheia (${wipLimit})` };
        return { valid: true, reason: '' };
    },
    calculateWork(agentType, column, diceRoll, specialistCount = 1) {
        const agent = CONFIG.AGENT_EFFICIENCY[agentType];
        let work = diceRoll * agent.baseEfficiency * specialistCount;
        if (column === agent.specialtyColumn) work *= agent.specialtyMultiplier;
        return work;
    },
    calculateDeadline(value, effort) {
        const config = CONFIG.DEADLINE_CALCULATION;
        let deadline = config.BASE_DAYS + (value / 100) * config.DAYS_PER_100_VALUE;
        deadline = Math.max(deadline, config.MIN_DEADLINE);
        deadline = Math.max(deadline, effort * 0.5);
        return Math.round(deadline);
    },
    calculateCriticality(value) {
        if (value >= 600) return 'urgent';
        if (value >= 400) return 'high';
        if (value >= 200) return 'medium';
        return 'low';
    },
    calculateLatePenalty(daysLate, originalValue) {
        if (daysLate <= 0) return originalValue;
        const penaltyPercent = Math.min(daysLate * CONFIG.PENALTIES.LATE_PENALTY_PERCENT, CONFIG.PENALTIES.MAX_PENALTY_PERCENT);
        return Math.round(originalValue * (1 - penaltyPercent));
    },
    isStale(card, currentDay) {
        return (currentDay - card.lastMovedDay) >= CONFIG.STALE_THRESHOLD;
    },
    calculateLeadTime(card) {
        if (!card.startedDay || !card.completedDay) return 0;
        return card.completedDay - card.startedDay;
    },
    calculateMetrics(gameState) {
        const deployed = gameState.cards.filter(c => c.currentColumn === 'deployed');
        const totalValue = deployed.reduce((sum, c) => sum + (c.finalValue !== undefined ? c.finalValue : c.value), 0);
        const totalCost = (gameState.dailyCostHistory || []).reduce((sum, cost) => sum + cost, 0);
        const leadTimes = deployed.filter(c => c.completedDay && c.startedDay).map(c => c.completedDay - c.startedDay);
        const avgLeadTime = leadTimes.length > 0 ? (leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length).toFixed(1) : 0;
        const throughput = gameState.day > 0 ? (deployed.length / gameState.day).toFixed(2) : 0;
        let blockedCount = 0;
        CONFIG.COLUMN_ORDER.forEach(col => {
            const count = gameState.cards.filter(c => c.currentColumn === col).length;
            if (count >= CONFIG.WIP_LIMITS[col]) blockedCount += count;
        });
        return { totalValue, totalCost, profit: totalValue - totalCost, avgLeadTime, throughput, blockedCount, deployedCount: deployed.length };
    }
};

window.CONFIG = CONFIG; window.SAMPLE_CARDS = SAMPLE_CARDS; window.Rules = Rules;

// ===================================================================================
// ESTADO E L√ìGICA DO JOGO
// ===================================================================================
let GameState = {
    day: 0,
    cards: [],
    agents: {},
    specialistAllocations: {},
    agentAbsences: {},
    history: [],
    metrics: { cfd: [], leadTimes: [], financial: [], throughput: [] },
    diceResults: {},
    dailyCostHistory: [],
    isRunning: false
};

function initGame() {
    GameState = {
        day: 0,
        cards: [],
        agents: {
            analyst: { type: 'analyst', lastDice: 0, available: true },
            developer: { type: 'developer', lastDice: 0, available: true },
            tester: { type: 'tester', lastDice: 0, available: true }
        },
        specialistAllocations: {},
        agentAbsences: { analyst: 0, developer: 0, tester: 0 },
        history: [],
        metrics: { cfd: [], leadTimes: [], financial: [], throughput: [] },
        diceResults: {},
        dailyCostHistory: [],
        isRunning: true
    };
    window.GameState = GameState;
    GameState.cards = SAMPLE_CARDS.map((card, index) => {
        const effort = card.effort;
        const value = card.value;
        const deadline = Rules.calculateDeadline(value, effort);
        const priority = Rules.calculateCriticality(value);
        return {
            ...card,
            id: card.id || `C${String(index + 1).padStart(3, '0')}`,
            currentColumn: 'backlog',
            effortRequired: effort,
            effortDone: 0,
            priority: priority,
            originalPriority: card.priority || priority,
            value: value,
            originalValue: value,
            finalValue: value,
            deadline: deadline,
            createdDay: 0,
            startedDay: null,
            completedDay: null,
            lastMovedDay: 0,
            hasBug: false,
            readyForDeployment: false
        };
    });
    recordCFD();
    addHistory('system', 'Jogo iniciado', `${GameState.cards.length} cart√µes no backlog`);
    return GameState;
}

function processDay() {
    if (!GameState.isRunning) return null;
    GameState.day++;
    processAbsences();
    const events = generateRandomEvents();
    const diceResults = {};
    Object.keys(GameState.agents).forEach(agentType => {
        if (GameState.agentAbsences[agentType] > 0) {
            diceResults[agentType] = 0;
        } else {
            const dice = rollDice();
            diceResults[agentType] = dice;
            GameState.agents[agentType].lastDice = dice;
        }
    });
    GameState.diceResults = diceResults;
    const workReport = [];
    CONFIG.WORK_COLUMNS.forEach(column => {
        const cardsInColumn = GameState.cards.filter(c => c.currentColumn === column);
        if (cardsInColumn.length === 0) return;
        let agentType;
        if (column === 'analysis') agentType = 'analyst';
        else if (column === 'development') agentType = 'developer';
        else if (column === 'testing') agentType = 'tester';
        if (GameState.agentAbsences[agentType] > 0) {
            addHistory('absence', `${CONFIG.AGENT_EFFICIENCY[agentType].name} ausente`, `Indispon√≠vel por mais ${GameState.agentAbsences[agentType]} dia(s)`);
            return;
        }
        const dice = diceResults[agentType];
        cardsInColumn.forEach(card => {
            const specialistCount = GameState.specialistAllocations[card.id]?.[column] || 0;
            if (specialistCount === 0) return;
            const work = Rules.calculateWork(agentType, column, dice, specialistCount);
            const previousEffort = card.effortDone;
            card.effortDone = Math.min(card.effortRequired, card.effortDone + work);
            const actualWork = card.effortDone - previousEffort;
            workReport.push({ agent: CONFIG.AGENT_EFFICIENCY[agentType].name, card: card.title, dice, specialists: specialistCount, work: actualWork, progress: `${card.effortDone}/${card.effortRequired}` });
            if (card.effortDone >= card.effortRequired) {
                if (column === 'testing' && !card.hasBug && Math.random() < CONFIG.EVENTS.TESTER_BUG_DETECTION) {
                    card.hasBug = true;
                    card.effortDone = 0;
                    card.currentColumn = 'development';
                    card.lastMovedDay = GameState.day;
                    if (GameState.specialistAllocations[card.id]) GameState.specialistAllocations[card.id]['testing'] = 0;
                    addHistory('bug', `üêõ Bug detectado em "${card.title}"`, 'Testador identificou problema - retornando para desenvolvimento');
                } else {
                    addHistory('work', `"${card.title}" pronto para avan√ßar`, `Trabalho completo na etapa ${getColumnName(column)}`);
                    if (column === 'testing' && !card.hasBug) card.readyForDeployment = true;
                }
            }
        });
    });
    const dailyCost = calculateDailyCost();
    GameState.dailyCostHistory.push(dailyCost);
    recordCFD();
    recordFinancial();
    recordThroughput();
    const diceStr = Object.entries(diceResults).map(([agent, dice]) => `${CONFIG.AGENT_EFFICIENCY[agent].name}: üé≤${dice}`).join(', ');
    addHistory('dice', `Dia ${GameState.day}`, diceStr);
    events.forEach(event => addHistory(event.type, event.title, event.description));
    workReport.forEach(w => addHistory('work', `${w.agent} (${w.specialists}x) trabalhou em "${w.card}"`, `Dado: ${w.dice}, Progresso: ${w.progress}`));
    return { day: GameState.day, diceResults, workReport, events, dailyCost };
}

function rollDice() { return Math.floor(Math.random() * 6) + 1; }
function processAbsences() {
    Object.keys(GameState.agentAbsences).forEach(agentType => {
        if (GameState.agentAbsences[agentType] > 0) {
            GameState.agentAbsences[agentType]--;
            if (GameState.agentAbsences[agentType] === 0) {
                GameState.agents[agentType].available = true;
                addHistory('info', `${CONFIG.AGENT_EFFICIENCY[agentType].name} retornou`, 'Especialista dispon√≠vel novamente');
            }
        }
    });
}

function generateRandomEvents() {
    const events = [];
    if (Math.random() < CONFIG.EVENTS.BUG_CHANCE_PER_DAY) {
        const bugCard = createBugCard();
        GameState.cards.push(bugCard);
        events.push({ type: 'bug', title: 'üêõ Novo Bug Identificado', description: `Card de bug "${bugCard.title}" adicionado ao backlog` });
    }
    if (Math.random() < CONFIG.EVENTS.ABSENCE_CHANCE_PER_DAY) {
        const agentTypes = Object.keys(GameState.agents);
        const availableAgents = agentTypes.filter(type => GameState.agentAbsences[type] === 0);
        if (availableAgents.length > 0) {
            const randomAgent = availableAgents[Math.floor(Math.random() * availableAgents.length)];
            const duration = Math.random() < 0.5 ? 1 : 2;
            const reasons = ['atestado m√©dico', 'banco de horas', 'licen√ßa'];
            const reason = reasons[Math.floor(Math.random() * reasons.length)];
            GameState.agentAbsences[randomAgent] = duration;
            GameState.agents[randomAgent].available = false;
            events.push({ type: 'absence', title: `‚ö†Ô∏è ${CONFIG.AGENT_EFFICIENCY[randomAgent].name} Ausente`, description: `Motivo: ${reason} - Dura√ß√£o: ${duration} dia(s)` });
        }
    }
    return events;
}

function createBugCard() {
    const bugTitles = ['Erro de valida√ß√£o', 'Bug cr√≠tico em produ√ß√£o', 'Problema de performance', 'Interface quebrada', 'Falha de seguran√ßa', 'Inconsist√™ncia de dados'];
    const title = bugTitles[Math.floor(Math.random() * bugTitles.length)];
    const value = Math.floor(Math.random() * 3) + 1;
    const effort = Math.floor(Math.random() * 10) + 5;
    const deadline = GameState.day + Rules.calculateDeadline(value, effort);
    return { id: `bug-${Date.now()}`, title, value, effortRequired: effort, effortDone: 0, currentColumn: 'backlog', createdDay: GameState.day, hasBug: true, readyForDeployment: false, deadline, priority: Rules.calculateCriticality(value) };
}

function calculateDailyCost() {
    let totalSpecialists = 0;
    Object.values(GameState.specialistAllocations).forEach(allocations => { Object.values(allocations).forEach(count => { totalSpecialists += count; }); });
    return Math.max(CONFIG.DAILY_COST_BASE, totalSpecialists * CONFIG.DAILY_COST_PER_SPECIALIST);
}

function allocateSpecialists(cardId, column, count) {
    const card = GameState.cards.find(c => c.id === cardId);
    if (!card) return { success: false, reason: 'Cart√£o n√£o encontrado' };
    if (card.currentColumn !== column) return { success: false, reason: 'Cart√£o n√£o est√° nesta coluna' };
    if (count < 0 || count > CONFIG.MAX_SPECIALISTS_PER_COLUMN) return { success: false, reason: `M√°ximo ${CONFIG.MAX_SPECIALISTS_PER_COLUMN} especialistas por coluna` };
    const cardsInColumn = GameState.cards.filter(c => c.currentColumn === column);
    let totalInColumn = 0;
    cardsInColumn.forEach(c => { if (c.id !== cardId && GameState.specialistAllocations[c.id]) totalInColumn += GameState.specialistAllocations[c.id][column] || 0; });
    if (totalInColumn + count > CONFIG.MAX_SPECIALISTS_PER_COLUMN) return { success: false, reason: `M√°ximo ${CONFIG.MAX_SPECIALISTS_PER_COLUMN} especialistas na coluna. J√° alocados: ${totalInColumn}` };
    if (!GameState.specialistAllocations[cardId]) GameState.specialistAllocations[cardId] = {};
    GameState.specialistAllocations[cardId][column] = count;
    addHistory('allocation', `Especialistas alocados em "${card.title}"`, `${count}x especialista(s) em ${getColumnName(column)}`);
    return { success: true, count };
}

function moveCard(cardId, toColumn) {
    const card = GameState.cards.find(c => c.id === cardId);
    if (!card) return { success: false, reason: 'Cart√£o n√£o encontrado' };
    const fromColumn = card.currentColumn;
    if (fromColumn === 'deployed') return { success: false, reason: 'Cart√µes entregues n√£o podem ser movidos' };
    GameState._movingCardId = cardId;
    const validation = Rules.validateMove(fromColumn, toColumn, GameState);
    GameState._movingCardId = null;
    if (!validation.valid) return { success: false, reason: validation.reason };
    const fromIndex = CONFIG.COLUMN_ORDER.indexOf(fromColumn);
    const toIndex = CONFIG.COLUMN_ORDER.indexOf(toColumn);
    if (toIndex > fromIndex && CONFIG.WORK_COLUMNS.includes(fromColumn)) {
        if (card.effortDone < card.effortRequired) return { success: false, reason: `Trabalho incompleto: ${card.effortDone}/${card.effortRequired}` };
        card.effortDone = 0;
    }
    card.currentColumn = toColumn;
    card.lastMovedDay = GameState.day;
    if (toColumn === 'ready' && !card.startedDay) card.startedDay = GameState.day;
    if (toColumn === 'deployed') {
        card.completedDay = GameState.day;
        const daysLate = GameState.day - card.deadline;
        const finalValue = Rules.calculateLatePenalty(daysLate, card.value);
        card.finalValue = finalValue;
        const leadTime = Rules.calculateLeadTime(card);
        GameState.metrics.leadTimes.push({ cardId: card.id, title: card.title, leadTime, value: finalValue });
        let message = `Lead Time: ${leadTime} dias`;
        if (daysLate > 0) {
            const penalty = card.value - finalValue;
            message += ` ‚ö†Ô∏è ATRASADO! Penalidade: R$ ${penalty}, Valor Final: R$ ${finalValue}`;
            addHistory('penalty', `"${card.title}" entregue com atraso`, message);
        } else {
            message += `, Valor: R$ ${finalValue}`;
            addHistory('complete', `"${card.title}" conclu√≠do!`, message);
        }
    } else {
        addHistory('move', `"${card.title}" movido`, `${getColumnName(fromColumn)} ‚Üí ${getColumnName(toColumn)}`);
    }
    recordCFD();
    return { success: true, card };
}

function addCard(cardData) {
    const id = `C${String(GameState.cards.length + 1).padStart(3, '0')}`;
    const card = {
        id,
        title: sanitizeText(cardData.title),
        description: sanitizeText(cardData.description || ''),
        priority: cardData.priority || 'medium',
        category: cardData.category || 'feature',
        effortRequired: parseInt(cardData.effort) || 5,
        effortDone: 0,
        value: parseInt(cardData.value) || 100,
        currentColumn: 'backlog',
        createdDay: GameState.day,
        startedDay: null,
        completedDay: null,
        lastMovedDay: GameState.day
    };
    GameState.cards.push(card);
    addHistory('add', `Novo cart√£o: "${card.title}"`, `Esfor√ßo: ${card.effortRequired}, Valor: R$ ${card.value}`);
    recordCFD();
    return card;
}

function addHistory(type, action, details) {
    GameState.history.unshift({ day: GameState.day, type, action, details, timestamp: new Date().toISOString() });
    if (GameState.history.length > 100) GameState.history.pop();
}

function recordCFD() {
    const cfdEntry = { day: GameState.day, backlog: countCardsInColumn('backlog'), ready: countCardsInColumn('ready'), analysis: countCardsInColumn('analysis'), development: countCardsInColumn('development'), testing: countCardsInColumn('testing'), deployed: countCardsInColumn('deployed') };
    GameState.metrics.cfd.push(cfdEntry);
}

function recordFinancial() {
    const deployed = GameState.cards.filter(c => c.currentColumn === 'deployed');
    const totalValue = deployed.reduce((sum, c) => sum + (c.finalValue !== undefined ? c.finalValue : c.value), 0);
    const totalCost = (GameState.dailyCostHistory || []).reduce((sum, cost) => sum + cost, 0);
    GameState.metrics.financial.push({ day: GameState.day, value: totalValue, cost: totalCost, profit: totalValue - totalCost });
}

function recordThroughput() {
    const deployed = GameState.cards.filter(c => c.currentColumn === 'deployed');
    const completedToday = deployed.filter(c => c.completedDay === GameState.day).length;
    GameState.metrics.throughput.push({ day: GameState.day, completed: completedToday, cumulative: deployed.length });
}

function countCardsInColumn(column) { return GameState.cards.filter(c => c.currentColumn === column).length; }
function exportGameState() { return JSON.stringify(GameState, null, 2); }
function importGameState(jsonString) {
    try {
        const state = JSON.parse(jsonString);
        if (!state.cards || !Array.isArray(state.cards)) return { success: false, reason: 'Estado inv√°lido: cards ausente' };
        if (typeof state.day !== 'number') return { success: false, reason: 'Estado inv√°lido: day ausente' };
        GameState = state; GameState.isRunning = true; window.GameState = GameState; return { success: true };
    } catch (e) {
        return { success: false, reason: 'JSON inv√°lido: ' + e.message };
    }
}
function sanitizeText(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
function getColumnName(column) { const names = { backlog: 'Backlog', ready: 'Pronto', analysis: 'An√°lise', development: 'Desenvolvimento', testing: 'Teste', deployed: 'Conclu√≠do' }; return names[column] || column; }
function getGameState() { return GameState; }
function restartGame() { initGame(); }
window.GameState = GameState; window.initGame = initGame; window.processDay = processDay; window.moveCard = moveCard; window.addCard = addCard; window.exportGameState = exportGameState; window.importGameState = importGameState; window.getGameState = getGameState; window.restartGame = restartGame; window.getColumnName = getColumnName; window.countCardsInColumn = countCardsInColumn;

// ===================================================================================
// GR√ÅFICOS (CANVAS PURO)
// ===================================================================================
const CHART_CONFIG = { colors: { backlog: '#6c757d', ready: '#17a2b8', analysis: '#e74c3c', development: '#2ecc71', testing: '#3498db', deployed: '#27ae60', value: '#2ecc71', cost: '#e74c3c', profit: '#3498db', throughput: '#9b59b6' }, padding: 40, gridLines: 5, animationDuration: 300 };
class ChartRenderer {
    constructor(canvasId) { this.canvas = document.getElementById(canvasId); if (!this.canvas) { console.warn(`Canvas ${canvasId} n√£o encontrado`); return; } this.ctx = this.canvas.getContext('2d'); this.resize(); window.addEventListener('resize', () => this.resize()); }
    resize() { if (!this.canvas) return; const rect = this.canvas.parentElement.getBoundingClientRect(); this.canvas.width = rect.width - 20; this.canvas.height = 200; this.width = this.canvas.width; this.height = this.canvas.height; }
    clear() { if (!this.ctx) return; this.ctx.clearRect(0, 0, this.width, this.height); }
    drawGrid(maxValue) { if (!this.ctx) return; const padding = CHART_CONFIG.padding; const gridLines = CHART_CONFIG.gridLines; this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)'; this.ctx.lineWidth = 1; for (let i = 0; i <= gridLines; i++) { const y = padding + (this.height - padding * 2) * (i / gridLines); this.ctx.beginPath(); this.ctx.moveTo(padding, y); this.ctx.lineTo(this.width - padding, y); this.ctx.stroke(); const value = Math.round(maxValue * (1 - i / gridLines)); this.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)'; this.ctx.font = '10px sans-serif'; this.ctx.textAlign = 'right'; this.ctx.fillText(value.toString(), padding - 5, y + 3); } }
    drawXLabels(labels) { if (!this.ctx || labels.length === 0) return; const padding = CHART_CONFIG.padding; const step = (this.width - padding * 2) / Math.max(labels.length - 1, 1); this.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)'; this.ctx.font = '10px sans-serif'; this.ctx.textAlign = 'center'; labels.forEach((label, i) => { if (i % Math.ceil(labels.length / 10) === 0 || labels.length <= 10) { const x = padding + step * i; this.ctx.fillText(label, x, this.height - 10); } }); }
}
class CFDChart extends ChartRenderer {
    constructor() { super('cfdChart'); }
    draw(data) {
        if (!this.ctx || !data || data.length === 0) return; this.clear(); const padding = CHART_CONFIG.padding; const chartWidth = this.width - padding * 2; const chartHeight = this.height - padding * 2; const maxTotal = Math.max(...data.map(d => d.backlog + d.ready + d.analysis + d.development + d.testing + d.deployed), 1); this.drawGrid(maxTotal); const columns = ['deployed', 'testing', 'development', 'analysis', 'ready', 'backlog']; const step = chartWidth / Math.max(data.length - 1, 1); columns.forEach((col, colIndex) => { this.ctx.beginPath(); this.ctx.fillStyle = CHART_CONFIG.colors[col] + '80'; data.forEach((d, i) => { const x = padding + step * i; let yBase = 0; for (let j = 0; j < colIndex; j++) { yBase += d[columns[j]]; } const yTop = yBase + d[col]; const yBasePx = this.height - padding - (yBase / maxTotal) * chartHeight; const yTopPx = this.height - padding - (yTop / maxTotal) * chartHeight; if (i === 0) { this.ctx.moveTo(x, yBasePx); } this.ctx.lineTo(x, yTopPx); }); for (let i = data.length - 1; i >= 0; i--) { const x = padding + step * i; let yBase = 0; for (let j = 0; j < colIndex; j++) { yBase += data[i][columns[j]]; } const yBasePx = this.height - padding - (yBase / maxTotal) * chartHeight; this.ctx.lineTo(x, yBasePx); } this.ctx.closePath(); this.ctx.fill(); }); this.drawXLabels(data.map(d => `D${d.day}`)); this.drawLegend(columns); }
    drawLegend(columns) { const legendY = 15; let legendX = CHART_CONFIG.padding; this.ctx.font = '10px sans-serif'; columns.reverse().forEach(col => { this.ctx.fillStyle = CHART_CONFIG.colors[col]; this.ctx.fillRect(legendX, legendY - 8, 10, 10); this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'; const name = getColumnName(col); this.ctx.fillText(name, legendX + 14, legendY); legendX += this.ctx.measureText(name).width + 25; }); }
}
class LeadTimeChart extends ChartRenderer {
    constructor() { super('leadTimeChart'); }
    draw(data) {
        if (!this.ctx || !data || data.length === 0) { this.drawEmpty(); return; }
        this.clear(); const padding = CHART_CONFIG.padding; const chartWidth = this.width - padding * 2; const chartHeight = this.height - padding * 2; const maxLeadTime = Math.max(...data.map(d => d.leadTime), 1); this.drawGrid(maxLeadTime); const barWidth = Math.min(30, chartWidth / data.length - 5); const step = chartWidth / data.length; data.forEach((d, i) => { const x = padding + step * i + (step - barWidth) / 2; const barHeight = (d.leadTime / maxLeadTime) * chartHeight; const y = this.height - padding - barHeight; const hue = 120 - (d.leadTime / maxLeadTime) * 120; this.ctx.fillStyle = `hsl(${hue}, 70%, 50%)`; this.ctx.fillRect(x, y, barWidth, barHeight); this.ctx.fillStyle = 'white'; this.ctx.font = '10px sans-serif'; this.ctx.textAlign = 'center'; this.ctx.fillText(d.leadTime.toString(), x + barWidth / 2, y - 5); }); this.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)'; this.ctx.font = '9px sans-serif'; data.forEach((d, i) => { const x = padding + step * i + step / 2; const label = d.cardId.slice(-3); this.ctx.fillText(label, x, this.height - 10); }); const avg = data.reduce((sum, d) => sum + d.leadTime, 0) / data.length; const avgY = this.height - padding - (avg / maxLeadTime) * chartHeight; this.ctx.strokeStyle = '#f39c12'; this.ctx.lineWidth = 2; this.ctx.setLineDash([5, 5]); this.ctx.beginPath(); this.ctx.moveTo(padding, avgY); this.ctx.lineTo(this.width - padding, avgY); this.ctx.stroke(); this.ctx.setLineDash([]); this.ctx.fillStyle = '#f39c12'; this.ctx.fillText(`M√©dia: ${avg.toFixed(1)} dias`, this.width - padding - 60, avgY - 5); }
    drawEmpty() { this.clear(); this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)'; this.ctx.font = '14px sans-serif'; this.ctx.textAlign = 'center'; this.ctx.fillText('Nenhum cart√£o conclu√≠do ainda', this.width / 2, this.height / 2); }
}
class FinancialChart extends ChartRenderer {
    constructor() { super('financialChart'); }
    draw(data) {
        if (!this.ctx || !data || data.length === 0) return; this.clear(); const padding = CHART_CONFIG.padding; const chartWidth = this.width - padding * 2; const chartHeight = this.height - padding * 2; const allValues = data.flatMap(d => [d.value, d.cost, d.profit]); const maxValue = Math.max(...allValues, 1); const minValue = Math.min(...allValues, 0); const range = maxValue - minValue; this.drawGrid(maxValue); const step = chartWidth / Math.max(data.length - 1, 1); const zeroY = this.height - padding - ((-minValue) / range) * chartHeight; this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; this.ctx.lineWidth = 1; this.ctx.beginPath(); this.ctx.moveTo(padding, zeroY); this.ctx.lineTo(this.width - padding, zeroY); this.ctx.stroke(); const drawLine = (key, color) => { this.ctx.strokeStyle = color; this.ctx.lineWidth = 2; this.ctx.beginPath(); data.forEach((d, i) => { const x = padding + step * i; const y = this.height - padding - ((d[key] - minValue) / range) * chartHeight; if (i === 0) this.ctx.moveTo(x, y); else this.ctx.lineTo(x, y); }); this.ctx.stroke(); data.forEach((d, i) => { const x = padding + step * i; const y = this.height - padding - ((d[key] - minValue) / range) * chartHeight; this.ctx.beginPath(); this.ctx.arc(x, y, 3, 0, Math.PI * 2); this.ctx.fillStyle = color; this.ctx.fill(); }); };
        drawLine('value', CHART_CONFIG.colors.value); drawLine('cost', CHART_CONFIG.colors.cost); drawLine('profit', CHART_CONFIG.colors.profit); this.drawXLabels(data.map(d => `D${d.day}`)); this.drawFinancialLegend(); }
    drawFinancialLegend() { const legendY = 15; let legendX = CHART_CONFIG.padding; this.ctx.font = '10px sans-serif'; const items = [{ key: 'Valor', color: CHART_CONFIG.colors.value }, { key: 'Custo', color: CHART_CONFIG.colors.cost }, { key: 'Lucro', color: CHART_CONFIG.colors.profit }]; items.forEach(item => { this.ctx.fillStyle = item.color; this.ctx.fillRect(legendX, legendY - 8, 10, 10); this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'; this.ctx.fillText(item.key, legendX + 14, legendY); legendX += this.ctx.measureText(item.key).width + 30; }); }
}
class ThroughputChart extends ChartRenderer {
    constructor() { super('throughputChart'); }
    draw(data) {
        if (!this.ctx || !data || data.length === 0) return; this.clear(); const padding = CHART_CONFIG.padding; const chartWidth = this.width - padding * 2; const chartHeight = this.height - padding * 2; const maxCompleted = Math.max(...data.map(d => d.completed), 1); this.drawGrid(maxCompleted); const barWidth = Math.min(20, chartWidth / data.length - 2); const step = chartWidth / data.length; data.forEach((d, i) => { const x = padding + step * i + (step - barWidth) / 2; const barHeight = (d.completed / maxCompleted) * chartHeight; const y = this.height - padding - barHeight; this.ctx.fillStyle = CHART_CONFIG.colors.throughput; this.ctx.fillRect(x, y, barWidth, barHeight); if (d.completed > 0) { this.ctx.fillStyle = 'white'; this.ctx.font = '10px sans-serif'; this.ctx.textAlign = 'center'; this.ctx.fillText(d.completed.toString(), x + barWidth / 2, y - 5); } }); if (data.length >= 3) { this.ctx.strokeStyle = '#f39c12'; this.ctx.lineWidth = 2; this.ctx.beginPath(); for (let i = 2; i < data.length; i++) { const avg = (data[i-2].completed + data[i-1].completed + data[i].completed) / 3; const x = padding + step * i + step / 2; const y = this.height - padding - (avg / maxCompleted) * chartHeight; if (i === 2) this.ctx.moveTo(x, y); else this.ctx.lineTo(x, y); } this.ctx.stroke(); }
        this.drawXLabels(data.map(d => `D${d.day}`)); }
}
const Charts = { cfd: null, leadTime: null, financial: null, throughput: null, init() { this.cfd = new CFDChart(); this.leadTime = new LeadTimeChart(); this.financial = new FinancialChart(); this.throughput = new ThroughputChart(); }, updateAll(gameState) { if (!gameState || !gameState.metrics) return; if (this.cfd) this.cfd.draw(gameState.metrics.cfd); if (this.leadTime) this.leadTime.draw(gameState.metrics.leadTimes); if (this.financial) this.financial.draw(gameState.metrics.financial); if (this.throughput) this.throughput.draw(gameState.metrics.throughput); }, resize() { if (this.cfd) this.cfd.resize(); if (this.leadTime) this.leadTime.resize(); if (this.financial) this.financial.resize(); if (this.throughput) this.throughput.resize(); const state = getGameState(); if (state) this.updateAll(state); } };
window.addEventListener('resize', () => { requestAnimationFrame(() => Charts.resize()); });
window.Charts = Charts;

// ===================================================================================
// UI E INTERA√á√ïES
// ===================================================================================
document.addEventListener('DOMContentLoaded', () => {
    initGame(); Charts.init(); renderBoard(); updateStats(); updateHistory(); Charts.updateAll(getGameState()); setupEventListeners(); showToast('Bem-vindo ao Kanban EV!', 'info'); updateGameStatus('Pronto para jogar');
});

function setupEventListeners() {
    document.getElementById('btnNextDay').addEventListener('click', handleNextDay);
    document.getElementById('btnRestart').addEventListener('click', handleRestart);
    document.getElementById('btnHelp').addEventListener('click', () => openModal('modalHelp'));
    document.getElementById('btnAddCard').addEventListener('click', () => { document.getElementById('formCard').reset(); document.getElementById('modalCardTitle').textContent = 'Adicionar Cart√£o'; openModal('modalCard'); });
    document.getElementById('formCard').addEventListener('submit', handleAddCard);
    document.getElementById('btnCancelCard').addEventListener('click', () => closeModal('modalCard'));
    document.getElementById('btnExportState').addEventListener('click', handleExport);
    document.getElementById('btnImportState').addEventListener('click', () => openModal('modalImport'));
    document.getElementById('btnCopyExport').addEventListener('click', handleCopyExport);
    document.getElementById('btnConfirmImport').addEventListener('click', handleImport);
    document.querySelectorAll('.modal-close, .modal-close-btn').forEach(btn => { btn.addEventListener('click', (e) => { const modal = e.target.closest('.modal'); if (modal) closeModal(modal.id); }); });
    document.querySelectorAll('.modal').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal.id); }); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { document.querySelectorAll('.modal.active').forEach(modal => closeModal(modal.id)); } });
    setupDragAndDrop();
}

function handleNextDay() {
    const state = getGameState();
    if (state) {
        const warnings = getUnallocatedSpecialistsWarnings(state);
        if (warnings.length > 0) {
            const message = '‚ö†Ô∏è Existem especialistas sem tarefa alocada para hoje:\n\n' + warnings.join('\n') + '\n\nDeseja realmente prosseguir para o pr√≥ximo dia?';
            const ok = confirm(message); if (!ok) return;
        }
    }
    const btn = document.getElementById('btnNextDay');
    btn.disabled = true; btn.textContent = '‚è≥ Processando...';
    setTimeout(() => {
        const result = processDay();
        if (result) { renderBoard(); updateStats(); updateHistory(); updateDiceDisplay(result.diceResults); Charts.updateAll(getGameState()); showToast(`Dia ${result.day} processado!`, 'success'); showDiceResults(result.diceResults); updateGameStatus(`Dia ${result.day} - Em andamento`); }
        btn.disabled = false; btn.textContent = 'üé≤ Pr√≥ximo Dia';
    }, 500);
}

function getUnallocatedSpecialistsWarnings(state) {
    const warnings = []; const workColumns = CONFIG.WORK_COLUMNS || []; const maxPerColumn = CONFIG.MAX_SPECIALISTS_PER_COLUMN; if (!maxPerColumn || workColumns.length === 0) return warnings;
    workColumns.forEach(column => {
        const cardsInColumn = state.cards.filter(c => c.currentColumn === column); if (cardsInColumn.length === 0) return; let allocatedTotal = 0; const zeroAllocatedCards = [];
        cardsInColumn.forEach(card => { const allocatedForCard = state.specialistAllocations?.[card.id]?.[column] || 0; allocatedTotal += allocatedForCard; if (allocatedForCard === 0) zeroAllocatedCards.push(card); });
        const available = Math.max(0, maxPerColumn - allocatedTotal);
        if (available > 0 && zeroAllocatedCards.length > 0) warnings.push(`- ${getColumnName(column)}: ${zeroAllocatedCards.length} card(s) sem especialista e ${available} especialista(s) dispon√≠vel(is)`);
    });
    return warnings;
}

function handleRestart() {
    if (confirm('Tem certeza que deseja reiniciar o jogo? Todo o progresso ser√° perdido.')) {
        restartGame(); renderBoard(); updateStats(); updateHistory(); Charts.init(); Charts.updateAll(getGameState());
        document.querySelectorAll('.agent-dice').forEach(el => el.textContent = '-');
        document.querySelectorAll('.last-dice').forEach(el => el.textContent = '-');
        showToast('Jogo reiniciado!', 'info'); updateGameStatus('Pronto para jogar');
    }
}

function handleAddCard(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const cardData = { title: formData.get('title'), description: formData.get('description'), effort: formData.get('effort'), value: formData.get('value'), priority: formData.get('priority'), category: formData.get('category') };
    const card = addCard(cardData);
    renderBoard(); updateStats(); updateHistory();
    closeModal('modalCard'); showToast(`Cart√£o "${card.title}" adicionado!`, 'success');
}

function handleExport() { const json = exportGameState(); document.getElementById('exportData').value = json; document.getElementById('modalExportTitle').textContent = 'üì§ Exportar Estado'; openModal('modalExport'); }
function handleCopyExport() { const textarea = document.getElementById('exportData'); textarea.select(); document.execCommand('copy'); showToast('Estado copiado para a √°rea de transfer√™ncia!', 'success'); }
function handleImport() {
    const json = document.getElementById('importData').value; if (!json.trim()) { showToast('Cole o JSON do estado do jogo', 'warning'); return; }
    const result = importGameState(json);
    if (result.success) { renderBoard(); updateStats(); updateHistory(); Charts.updateAll(getGameState()); closeModal('modalImport'); showToast('Estado importado com sucesso!', 'success'); }
    else { showToast(`Erro: ${result.reason}`, 'error'); }
}

let draggedCard = null; let sourceColumn = null;
function setupDragAndDrop() {
    document.querySelectorAll('.cards-container').forEach(container => {
        container.addEventListener('dragover', handleDragOver);
        container.addEventListener('drop', handleDrop);
        container.addEventListener('dragleave', handleDragLeave);
    });
}
function handleDragStart(e) { draggedCard = e.target; sourceColumn = e.target.closest('.cards-container').id; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', e.target.dataset.cardId); highlightValidColumns(sourceColumn); }
function handleDragEnd(e) { e.target.classList.remove('dragging'); draggedCard = null; sourceColumn = null; document.querySelectorAll('.cards-container').forEach(container => container.classList.remove('drag-over', 'blocked')); }
function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const container = e.target.closest('.cards-container'); if (container && !container.classList.contains('blocked')) container.classList.add('drag-over'); }
function handleDragLeave(e) { const container = e.target.closest('.cards-container'); if (container) container.classList.remove('drag-over'); }
function handleDrop(e) { e.preventDefault(); const container = e.target.closest('.cards-container'); if (!container) return; container.classList.remove('drag-over'); const cardId = e.dataTransfer.getData('text/plain'); const toColumn = container.id; if (sourceColumn === toColumn) return; const result = moveCard(cardId, toColumn); if (result.success) { renderBoard(); updateStats(); updateHistory(); Charts.updateAll(getGameState()); showToast(`Cart√£o movido para ${getColumnName(toColumn)}`, 'success'); } else { showToast(result.reason, 'warning'); const cardEl = document.querySelector(`[data-card-id="${cardId}"]`); if (cardEl) { cardEl.style.animation = 'shake 0.5s'; setTimeout(() => cardEl.style.animation = '', 500); } } }
function highlightValidColumns(fromColumn) {
    const state = getGameState();
    CONFIG.COLUMN_ORDER.forEach(col => {
        const container = document.getElementById(col); if (!container) return;
        const validation = Rules.validateMove(fromColumn, col, state);
        if (!validation.valid && col !== fromColumn) container.classList.add('blocked');
    });
}

function renderBoard() { const state = getGameState(); CONFIG.COLUMN_ORDER.forEach(column => { renderColumn(column, state); }); updateWIPIndicators(state); setupDragAndDrop(); }
function renderColumn(columnId, state) {
    const container = document.getElementById(columnId); if (!container) return; container.innerHTML = '';
    const cards = state.cards.filter(c => c.currentColumn === columnId);
    cards.sort((a, b) => { const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 }; return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0); });
    cards.forEach(card => { container.appendChild(createCardElement(card, state.day, state)); });
    const columnEl = document.querySelector(`[data-column="${columnId}"]`); if (columnEl) { const countEl = columnEl.querySelector('.card-count'); if (countEl) countEl.textContent = cards.length; }
}
function createCardElement(card, currentDay, state) {
    const cardEl = document.createElement('div'); cardEl.className = `card priority-${card.priority}`; cardEl.draggable = true; cardEl.dataset.cardId = card.id;
    if (Rules.isStale(card, currentDay)) cardEl.classList.add('stale');
    if (card.hasBug) cardEl.classList.add('has-bug');
    if (card.currentColumn === 'deployed') cardEl.classList.add('deployed');
    const progress = card.effortRequired > 0 ? Math.min(100, (card.effortDone / card.effortRequired) * 100) : 0;
    const daysInColumn = currentDay - card.lastMovedDay;
    const criticality = card.deadline ? Rules.calculateCriticality(card.value, currentDay, card.deadline) : 'low';
    const daysUntilDeadline = card.deadline ? card.deadline - currentDay : null;
    let readyBadge = card.readyForDeployment && card.currentColumn !== 'deployed' ? '<div class="ready-badge">‚úÖ Pronto para Entrega</div>' : '';
    let bugIndicator = card.hasBug ? '<div class="bug-indicator">üêõ Bug Detectado</div>' : '';
    let deadlineIndicator = '';
    if (daysUntilDeadline !== null && card.currentColumn !== 'deployed') {
        const deadlineClass = criticality === 'urgent' ? 'deadline-urgent' : criticality === 'high' ? 'deadline-high' : criticality === 'medium' ? 'deadline-medium' : 'deadline-low';
        const deadlineText = daysUntilDeadline > 0 ? `${daysUntilDeadline} dias restantes` : daysUntilDeadline === 0 ? 'Prazo hoje!' : `${Math.abs(daysUntilDeadline)} dias de atraso`;
        deadlineIndicator = `<div class="deadline-indicator ${deadlineClass}">‚è∞ ${deadlineText}</div>`;
    }
    let specialistControls = '';
    if (CONFIG.WORK_COLUMNS.includes(card.currentColumn)) {
        const currentAllocation = state?.specialistAllocations?.[card.id]?.[card.currentColumn] || 0;
        specialistControls = `<div class="specialist-controls"><button class="specialist-btn" onclick="adjustSpecialists('${card.id}', '${card.currentColumn}', -1)">-</button><span class="specialist-count">üë• ${currentAllocation}</span><button class="specialist-btn" onclick="adjustSpecialists('${card.id}', '${card.currentColumn}', 1)">+</button></div>`;
    }
    const valueDisplay = card.currentColumn === 'deployed' && card.finalValue !== undefined ? `<span class="card-value ${card.finalValue < card.value ? 'penalty' : ''}">üí∞ R$ ${card.finalValue} ${card.finalValue < card.value ? '(Penalizado)' : ''}</span>` : `<span class="card-value">üí∞ R$ ${card.value}</span>`;
    cardEl.innerHTML = `<span class="card-category ${card.category}">${CONFIG.CATEGORIES[card.category]?.label || card.category}</span>${readyBadge}${bugIndicator}${deadlineIndicator}<div class="card-header"><span class="card-id">${card.id}</span><div class="card-title">${escapeHtml(card.title)}</div></div><div class="card-body">${card.currentColumn !== 'backlog' && card.currentColumn !== 'deployed' ? `<div class="card-progress"><div class="card-progress-bar" style="width: ${progress}%"></div></div>` : ''}<div class="card-stats"><span class="card-effort">‚ö° ${card.effortDone}/${card.effortRequired}</span>${valueDisplay}</div>${daysInColumn > 0 ? `<span class="card-days">üìÖ ${daysInColumn} dia(s) aqui</span>` : ''}${specialistControls}</div>`;
    cardEl.addEventListener('dragstart', handleDragStart); cardEl.addEventListener('dragend', handleDragEnd);
    return cardEl;
}

function updateWIPIndicators(state) {
    CONFIG.COLUMN_ORDER.forEach(column => {
        const columnEl = document.querySelector(`[data-column="${column}"]`); if (!columnEl) return;
        const wipBar = columnEl.querySelector('.wip-bar'); if (!wipBar) return;
        const count = state.cards.filter(c => c.currentColumn === column).length;
        const limit = CONFIG.WIP_LIMITS[column]; if (limit === Infinity) return;
        const percentage = (count / limit) * 100;
        wipBar.style.setProperty('--wip-percentage', `${percentage}%`);
        wipBar.classList.remove('warning', 'danger');
        if (percentage >= 100) wipBar.classList.add('danger'); else if (percentage >= 75) wipBar.classList.add('warning');
        wipBar.style.background = `linear-gradient(to right, ${percentage >= 100 ? '#dc3545' : percentage >= 75 ? '#ffc107' : '#28a745'} ${percentage}%, rgba(255,255,255,0.1) ${percentage}%)`;
    });
}

function updateStats() {
    const state = getGameState(); const metrics = Rules.calculateMetrics(state);
    document.getElementById('currentDay').textContent = state.day;
    document.getElementById('totalValue').textContent = `R$ ${metrics.totalValue}`;
    document.getElementById('totalCost').textContent = `R$ ${metrics.totalCost}`;
    const profitEl = document.getElementById('profit'); profitEl.textContent = `R$ ${metrics.profit}`; profitEl.className = `stat-value ${metrics.profit >= 0 ? 'positive' : 'negative'}`;
    document.getElementById('avgLeadTime').textContent = `${metrics.avgLeadTime} dias`;
    document.getElementById('throughput').textContent = `${metrics.throughput} / dia`;
    document.getElementById('blockedCount').textContent = metrics.blockedCount;
}

function updateHistory() {
    const state = getGameState(); const historyList = document.getElementById('historyList');
    if (state.history.length === 0) { historyList.innerHTML = '<p class="history-empty">Nenhuma a√ß√£o ainda...</p>'; return; }
    historyList.innerHTML = state.history.slice(0, 50).map(entry => `<div class="history-item"><span class="day">Dia ${entry.day}</span><span class="action">${escapeHtml(entry.action)}</span>${entry.details ? `<span class="details">${escapeHtml(entry.details)}</span>` : ''}</div>`).join('');
}

function updateDiceDisplay(diceResults) {
    const state = window.GameState;
    Object.entries(diceResults).forEach(([agent, dice]) => {
        const isAbsent = state && state.agentAbsences[agent] > 0; const slotId = agent + 'Dice'; const slotEl = document.getElementById(slotId);
        if (slotEl) { if (isAbsent) { slotEl.textContent = `‚ö†Ô∏è Ausente (${state.agentAbsences[agent]}d)`; slotEl.classList.add('agent-absent'); } else { slotEl.textContent = `üé≤ ${dice}`; slotEl.classList.remove('agent-absent'); slotEl.classList.add('animate-dice'); setTimeout(() => slotEl.classList.remove('animate-dice'), 1000); } }
        const agentSlot = document.querySelector(`.agent-slot[data-agent-type="${agent}"]`); if (agentSlot) { if (isAbsent) agentSlot.classList.add('absent'); else agentSlot.classList.remove('absent'); }
        const teamEl = document.getElementById(`team${capitalize(agent)}`); if (teamEl) { const diceSpan = teamEl.querySelector('.last-dice'); if (diceSpan) { diceSpan.textContent = isAbsent ? '‚ö†Ô∏è' : dice; } }
    });
}

function showDiceResults(diceResults) { let message = 'Dados: '; Object.entries(diceResults).forEach(([agent, dice]) => { const agentConfig = CONFIG.AGENT_EFFICIENCY[agent]; message += `${agentConfig.name}: ${dice}  `; }); showToast(message, 'info', 3000); }
function updateGameStatus(status) { document.getElementById('gameStatus').textContent = status; }
function openModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.add('active'); modal.setAttribute('aria-hidden', 'false'); const firstInput = modal.querySelector('input, textarea, button'); if (firstInput) firstInput.focus(); } }
function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.remove('active'); modal.setAttribute('aria-hidden', 'true'); } }

function adjustSpecialists(cardId, column, delta) {
    const state = getGameState(); if (!state) return;
    const currentAllocation = state.specialistAllocations[cardId]?.[column] || 0;
    const newCount = Math.max(0, Math.min(CONFIG.MAX_SPECIALISTS_PER_COLUMN, currentAllocation + delta));
    const result = allocateSpecialists(cardId, column, newCount);
    if (result.success) { renderBoard(); showToast(`Alocados ${newCount} especialista(s)`, 'success', 2000); } else { showToast(result.reason, 'error'); }
}

function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toastContainer');
    const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
    const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><span class="toast-message">${escapeHtml(message)}</span>`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.animation = 'toastSlideOut 0.3s ease forwards'; setTimeout(() => toast.remove(), 300); }, duration);
}
const extraStyle = document.createElement('style');
extraStyle.textContent = `
    @keyframes toastSlideOut { to { opacity: 0; transform: translateX(100%); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .animate-dice { animation: diceRoll 0.5s ease; }
    @keyframes diceRoll { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); color: #ffc107; } }
`;
document.head.appendChild(extraStyle);

function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }
window.showToast = showToast; window.renderBoard = renderBoard; window.updateStats = updateStats;
    </script>
</body>
</html>
